## 项目结构

```txt
protocol_infer/
├── core/                       # 不可变抽象层（地基）
│   ├── datamodel/              # 全系统统一数据结构
│   │   ├── raw_packet.py
│   │   ├── flow.py
│   │   ├── event.py
│   │   └── trace.py
│   │
│   ├── model/                  # FSM / EFSM / PEFSM
│   │   ├── fsm.py
│   │   ├── efsm.py
│   │   └── pefsm.py
│   │
│   └── interface/              # 所有 Strategy 接口
│       ├── pcap_parser.py
│       ├── flow_builder.py
│       ├── segmenter.py
│       ├── fsm_infer.py
│       ├── efsm_builder.py
│       └── prob_trainer.py
│
├── pcap_layer/                 # Layer 0 & 1
│   ├── parser/
│   │   ├── scapy_parser.py
│   │   └── tshark_parser.py
│   │
│   ├── flow/
│   │   ├── five_tuple.py
│   │   └── flow_builder.py
│   │
│   ├── segmentation/
│   │   ├── packet_level.py
│   │   ├── tcp_reassembly.py
│   │   └── delimiter_based.py
│   │
│   └── pipeline.py             # pcap → Trace
│
├── control_flow_layer/         # Layer 2
│   ├── features/
│   ├── inference/
│   └── baseline/
│
├── data_flow_layer/            # Layer 3
│   ├── abstraction/
│   ├── dependency/
│   └── baseline/
│
├── probabilistic_layer/        # Layer 4
│   ├── timing/
│   ├── statistics/
│   └── baseline/
│
└── experiments/

```

## 模块

### core 

整个分析pipeline的demo, 后续拓展以此为基础, 定义了抽象类, 以及各层次接口, 支持可拓展组件等

#### datamodel

定义层次间数据结构

#### model

定义状态机模型

#### interface

定义接口



### pcap_layer

数据预处理, 初步解析pcap文件, 最终获得trace作为fsm的输入, 其中的工作包括三部分:

- 生成raw_packet
- 生成session, 并且获得事件
- 生成trace

### control_flow_layer

构建fsm

### data_flow_layer

构建efsm

### probabilistic_layer

构建p-efsm

## 层次间数据结构

### pcap->fsm(raw_packet–>trace)

#### raw_packet

直接从pcap文件得到的信息, 是可恢复的信息, 即与pcap一一映射, 只不过结构化

```python
class RawPacket:
    timestamp: float
    src_ip: str
    dst_ip: str
    src_port: int
    dst_port: int
    transport: str      # TCP / UDP
    payload: bytes
```

#### session

会话层面, 得到哪些`raw_packet`属于同一个会话

```python
class SessionKey(NamedTuple):
    ip1: str
    port1: int
    ip2: str
    port2: int
    transport: str
class Session:
    key: SessionKey
    packets: list[RawPacket]		## 时间有序
```

#### MessageEvent

事件级, 一次通信中发生的事件

```python
class MessageEvent:
    timestamp: float
    direction: int     # +1 = A→B, -1 = B→A
    payload: bytes
    length: int
```

#### trace

完整通信的序列

```python
class Trace:
    flow_key: FlowKey
    events: list[MessageEvent]
```



